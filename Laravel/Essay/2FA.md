# 2요소 인증

## 아이디 패스워드 입력의 문제점

아이디 패스워드의 문제점은, 아이디, 패스워드만 알면 누구나 로그인을 할 수 있다는 점이다.

여러 웹 사이트에서 동일한 아이디, 비밀번호를 쓰는 경우도 있어서 하나의 사이트의 아이디 비밀번호가 해커에 의해 취득되면 다른 사이트에도 로그인을 할 수 있는 문제가 발생할 수 있다. 서비스별로 비밀번호를 다르게 해야 한다는 권장 사항이 있지만, 일반 유저들은 보안 보다는 비밀번호를 잊어 버려 로그인을 할 수 없다는 것에 더 큰 문제점을 느끼기 때문에 동일한 비밀번호를 사용하는 경우가 많다.

또는 다른 컴퓨터에서 구글 로그인을 했는데 로그인 정보를 동기화를 해 버려 아이디, 비밀번호가 다른 컴퓨터에 유출되어 보안이 뚫리는 등의 문제가 존재한다.

또는 해커는 레인보우 테이블 등을 이용한 무차별 대입을 통한 방식으로 비밀번호를 알아낼 수 있다. 대부분의 사이트에서 계정 정보 입력이 지정한 횟수 이상 잘못되면 일정 시간 동안 로그인을 하지 못하도록 락을 걸기 때문에 비밀번호를 알아내기 어려울 수 있으나 장기간 사용하지 않는 계정에 일정 시간 간격으로 계속 대입 시도를 하면 시간이 걸리더라도 뚫릴 수 있는 문제점이 생긴다.

## 2단계 인증이란?

기존의 아이디, 비밀번호를 사용한 로그인 방식 이외의 로그인을 하기 위해 하나의 단계를 더 추가해서 검증하는 것을 2단계 인증이라고 한다.

## 2단계 인증의 핵심

'아무나 인증 수단에 접근할 수 없다'는 것이다. 가능하면 물리적으로 구분된 별도의 인증 수단 등을 사용하여, 인증 수단에 접근하기 어려운 방식을 이용하는 것이 포인트이다.

## 2단계 인증의 종류

- 메일을 이용하여 인증
- 구글 어센티케이터를 이용한 인증
- 자사의 모바일 앱을 이용한 인증
- 소셜 로그인(외부 웹 서비스의 계정 정보를 통해서 로그인)을 이용하여 소셜 로그인 제공 업체의 2단계 인증을 이용
또는 자사 서비스의 모바일 앱을 이용해서 로그인을 하는 방식이 있다.

## 메일 인증의 문제

2단계 인증의 핵심은 '아무나 인증 수단에 접근할 수 없다.'인데 메일 서비스는 웹에서 로그인을 해서 접근을 할 수도 있기 때문에 물리적으로 구분된 별도의 인증 수단을 사용하지 않는다는 문제가 있다.

메일 서비스에서 2단계 인증에 대한 제약사항이 없는 도메인일 경우, 2단계 인증을 제한하는 편이 좋다. 모든 어카운트에 2단계 인증을 도입하게 하는 것이 목표인 경우가 많은데, 메일의 도메인 문제로 인증이 제한되는 경우가 존재할 수 있으므로 메일 인증 이외의 별도의 2단계 인증을 추가해야 하는 경우가 생길 수 있다.

또한 메일 인증에 2단계 인증이 되더라도 일회성 로그인이 아닌 신뢰할 수 있는 기기로 설정 등과 같은 장기 로그인이 되어 있는 경우, 해당 컴퓨터를 해킹한, 또는 이 컴퓨터가 공용 컴퓨터일 경우 제 3자에 의한 접근이 가능하므로 안전한 추가 인증 수단이 될 수 없다.

서비스에 따라 로그인 어카운트가 메일로 설정되지 않을 수도 있고, 메일이 등록되지 않을 수도 있기 때문에, 2단계 인증을 위해서는 메일을 추가적으로 요구해야 한다.

## 소셜 로그인의 문제

소셜 로그인의 경우도 메일 인증과 유사한 문제를 가지고 있다. 또한 소셜 로그인을 제공하는 기관에서 2단계 인증에 대한 API를 제공하지 않는다면, 자사 서비스에서 2단계 인증을 자사 정책에 의해 강제할 수 없는 경우가 있고, 소셜 로그인 업체의 정책에 따르는 수 밖에 없다.

## 자사의 모바일 앱을 이용한 인증의 문제

자사의 모바일 앱이 없는 경우 사용할 수 없으며, 자사의 모바일 앱이 있더라도 서비스의 종류가 다르면 인증 수단으로서 활용할 수 없다. 모바일 앱이 자사의 중심 서비스이고 나머지 서비스가 모바일 앱을 중심으로 이뤄질 때 적절한 인증 수단이 될 수 있다.

## 구글 어센티케이터

스마트 폰 앱의 인증을 이용해서 식별된 개인만이 접근 가능하므로 스마트폰은 별도의 분리된 물리적 인증 수단이므로 '아무나 인증 수단에 접근할 수 없다.'의 요구사항을 만족한다.

하지만 구글 어센티케이터를 이용한 인증 방식에 익숙하지 않은 사람이 많다는 문제점 때문에 보급에 교육이나 설명하는 자료가 필요하다.

## 라라벨에서 google authenticator 인증 구현

### 라이브러리 선정

라라벨에서 구글 어센티케이터를 설치하기 위해서는 'pragmarx/google2fa'라는 라이브러리를 사용한다.

이 라이브러리는 라라벨의 fortify에서 사용하고 있으므로, 라라벨이 유지되는 한 지속되는 라이브러리의 메인테인스가 이뤄질 것이라고 기대할 수 있다는 장점이 있다.

라이브러리를 직접 설치하지 않고, 라라벨의 fortify를 설치하면 내부에서 'pragmarx/google2fa'라이브러리를 사용하기 때문에 라이브러리 버전을 라라벨 쪽에서 대신 관리해 준다는 장점이 있다.

### 보안상 고려할 점

기본적으로 구글 어센티케이터 코드를 입력하는 창은 로그인을 한 이후에 별도의 화면을 통해서 인증을 하는데, 그 이유는 아이디와 패스워드를 입력했다는 사실을 서버측에서 기억하고 있다가, 반복되는 인증 코드 입력의 실패에도 아이디와 패스워드를 재입력하지 않게 하기 위해서이다. 또는 2단계 인증 기기를 가지러 가기위해 자리를 잠시 이탈할 수도 있고, 이 때 브라우저에 입력된 아이디와 패스워드를 탈취하는 시도가 일어나는 것을 방지하기 위해서이다.

### 로그인 설계

아이디와 비밀번호를 임시 토큰을 전달하는 방법 로그인후 리다이렉트가 될 때, 임시 토큰을 발행하여 세션에 토큰을 저장을 하고 리다이렉트로 전달되는 리퀘스트에 토큰을 넣어 발행한 토큰과 비교를 한다.

그럼 방금 전 로그인을 통해서 TOTP 입력 화면으로 넘어온 사람인지, 로그인을 하지 않고 TOTP 입력 화면으로 넘어온 사람인지 알 수가 있다.

토큰이 일치했다면 저장된 아이디와 비밀번호를 서버 세션에서 취득한다.

토큰이 일치하거나 불일치하거나 무조건 토큰을 저장한 세션을 삭제한다.

세션에서 취득한 아이디와 비밀번호로 로그인을 시도한다.

세션을 이용하지 않고 레디스나 DB에 직접 토큰을 저장하면, 하나의 어카운트가 여러 브라우저에서 로그인 해야하는 경우 TOTP 화면으로 이동하지 못하게 될 수도 있다.

### 해시화의 여부 고려

발행하고 세션에 저장한 토큰과 리다이렉트로 리퀘스트로 전송한 토큰 간의 일치만을 확인하면 되므로 토큰을 해시화 하는 방법을 생각해 볼 수 있다. 

토큰을 발행할 때 해시화를 해야 하는가? 리다이렉트 리퀘스트 내의 토큰을 취득한 후 할 수 있는 것이 있는가? 

토큰의 목적은 단순히 TOTP 화면에 엑세스하고 로그인 정보를 애플리케이션 내부에서 취득하기 위한 것으로 TOTP 화면에 접속했다면 토큰을 무효화된다. 리다이렉트 도중에 토큰을 취득하고, TOTP 코드 입력 화면으로 이동하는 것을 차단하고, 나중에 해당 토큰을 이용할 수 있도록 한다? 하지만 동일 세션에서 이뤄져야 하기 때문에 특별히 어떤 목적으로 사용하기 어렵다. 굳이 리소스가 드는 해시화를 할 필요는 없다.

### 리커버리 코드의 발행

백업 코드를 다운로드 할 때, 주의 사항을 잘 기입하고, 주의 사항이 기입된 문서와 함께 다운로드 하게 한다.

리커버리 코드는 아직 다운로드를 하지 않은 초기 1회만 발급하게 하며, 브라우저 탭을 닫기 전 또는 브라우저를 닫기 전까지는 다운로드 할 수 있도록 한다. 다운로드를 받았을 때, 세션이 소멸되면 더 이상 다운로드 받지 못하게 한다. 다운로드 받지 않았을 때는 다운로드가 이뤄질 때까지 다운로드 받을 수 있도록 한다.
