## 배치처리
- 프로그램은 유저와의 상호작용을 통해서 데이터를 생성, 저장, 변경하는 방식을 제공하는 컴퓨터 시스템이다.
- 유저와 시스템 간의 상호작용이 일어날 때 시스템에서 작업을 처리하기에 시간이 걸려 상호작용에 불편함을 주는 경우 또는 유저와의 상호작용 시점에 아닌 별도의 시점에 실행되어야 하는 작업의 경우 특정한 시간 패턴을 지정하여 유저와의 상호작용 없이 작업을 실행하는 방식이 배치 처리이다.

## 라라벨에서 배치 처리
- 라라벨에서 배치 처리를 위해 제공하는 기능은 스케쥴러와 잡이 있다.

### 스케쥴러
- 커멘드라인 명령어를 리눅스 cron으로 지정한 시간 패턴에 따라 실행하도록 하는 기능이다.
- 라라벨 프레임워크에서 작성된 아티산 콘솔 코드 형식으로 작성된 php 파일을 `php artisan`으로 시작되는 커멘드라인 명령어로 실행하도록 하는 기능이다.

### 잡
- 데이터베이스 등과 같은 저장소에 실행할 코드를 저장한 다음 저장한 순서대로 저장된 코드를 실행 시키는 기능이다.

## 잡 정의하기
- 라라벨 프레임워크에서 배치처리를 깔끔하게 구현하는 방법에 대해 생각해 보자.

### 잡(Job)의 특징
- 라라벨에서 job이란 하나의 코드 실행 단위를 뜻한다. 이 코드 실행 단위를 실행하는 도중에 에러가 발생하면 잡은 중단되며 실패한 잡은 지정한 횟수의 재실행을 할 수 있다.
- 라라벨에서 잡은 기본적으로 잡 클래스를 객체화하여 저장소에 저장한다. 객체화를 하기 때문에 잡 클래스를 정의할 때의 정의에 따라 객체의 상태를 지정할 수 있고 저장소에 저장되는 잡 단위마다 상태에 따른 다양한 동작을 지정할 수 있다.
- 하나의 작업에 대한 로직이 많아지게 되면 실행된 많은 처리의 실패에 대한 롤백과 성공에 커밋을 정의해야 하며 실행 시간도 오래 걸린다. 잡을 사용하는 것은 반복적인 패턴의 처리를 나누어 실행하여 롤백과 커밋에 대한 부담감을 줄이기 위한 방편이 된다. 처리에 대한 커밋의 단위가 작다면 실패한 단위에 대해서만 실패 이유를 개선 한 후 재처리를 할 수도 있기 때문에 컴퓨팅 리소스를 줄일 수 있는 장점 및 관리하기 좋다는 장점도 있다.

### 잡 스테이터스
- 웹에는 다양한 유형의 고객이 존재한다. 예를 들어 상품을 사는 사람이 존재하며 상품을 파는 사람도 존재할 것이다. 상품을 사는 사람의 정산 기능, 상품을 파는 사람의 정산 기능 등이 존재하며 주로 정산 기능은 배치처리작업을 통해서 정산 결과가 도출된다.
- 상품 구매자에 대한 배치 처리 로직과 상품 판매자에 대한 배치 처리 로직은 서로 다를 것이다. 그러나 상품 구매자들 각각에 대한 처리 로직은 상품 구매자가 가진 상태만이 달라질 뿐 처리 되어야 하는 로직은 동일하게 정의될 것이다. 각 상품구매자에 대해서 동일한 유형에 대한 처리 로직이 유저의 데이터의 차이 및 상태에 따라 달라질 뿐이므로 잡으로 정의하게 되면 각각의 유저에 대한 처리를 한 단위로 끝낼 수 있으며 모든 유저에 대한 처리도 할 수 있다. 이는 상품판매자에 대해서도 마찬가지이다.

## 프레임워크 내에서의 구조
- 라라벨에서 공식적으로 지원하는 폴더 배치는 아니다. 그러나 배치 유닛, 잡 클래스, 배치 서비스, 아티산 커멘드로 배치 처리를 구성하는 것이 배치 처리를 구조화 할 때 좋은 설계 방법이다.

### 배치 유닛
- 반복적으로 실행 가능한 배치 처리의 단위를 정의한 부분이다.

### 잡 클래스
- 잡은 데이터베이스와 같은 저장소에 잡을 저장하고 저장한 순서대로 잡 로직을 실행하게 하기 위한 로직을 처리하는 부분이다.
- 잡은 배치 유닛의 로직을 잡 저장소에 저장하고 저장한 순서대로 실행하는 큐 자료구조의 형태로 사용하기 위해 만들어진다.
- 처리에 관한 상세한 로직은 배치 유닛에 정의하며 배치 유닛을 사용하기 위한 용도로 쓰는 것이 좋다.

### 배치 서비스
- 배치 처리는 일괄처리라고도 말한다.
- 배치 유닛의 클래스를 여러 상태의 객체로 실행하여 다수의 대상에 대한 처리를 하기 위한 도구이다.
- 이 때 배치 유닛을 직접 실행하는 것이 아닌 잡 클래스를 통해서 배치 처리를 실행한다. 잡 클래스를 통해서 큐 저장소에 실행할 배치 유닛이 잡의 형태로 등록되어야 하기 때문이다.

### 아티산 커멘드
- 배치 처리를 실행할 시점을 정의하기 위해서는 스케쥴러에 등록을 해야 한다.
- 스케쥴러에 등록하기 위해서는 아티산 커멘드를 통해서 실행할 수 있도록 정의가 되어야 한다.
- 아티산 커멘드로 정의할 때는 일괄 처리를 실해하기 위한 배치 서비스를 직접 가져다 사용한다.
- 아티산 커멘드가 정의되었다면 스케쥴러에 언제 실행할 것인지 등록한다.

## 실행의 흐름
1. 리눅스의 cron 서비스가 동작한다.
2. cron의 실행에 따라 라라벨의 스케쥴러가 동작한다.
3. 라라벨 스케쥴러에 등록된 아티산 커멘드는 특정한 타이밍에 정의된 아티산 커멘드를 실행한다.
4. 아티산 커멘드는 배치 서비스를 실행한다.
5. 배치 서비스는 다양한 상태를 갖는 배치 유닛을 큐잡의 형태로 등록하기 위해서 다수의 잡을 저장소에 등록한다.
6. 등록된 잡은 순차적으로 실행되면서 유닛으로 정의된 단위로 로직을 처리한다.


## 폴더 구조
- 라라벨의 주요 비즈니스 로직들은 app 폴더 하단에 위치한다.
- 기본적으로 job의 경우 job 폴더가 라라벨에서 제공되기 때문에 배치 유닛을 사용하는 잡 클래스도 `app/job` 폴더 안에 정의하도록 한다. `app/job/baches` 폴더를 만들어 배치 유닛을 사용하는 잡 클래스를 정의하도록 하자. job 폴더를 사용하는 이유는 `php artisan make:job job파일명`으로 job 클래스 파일을 만드는데 `app/job` 경로가 아니면 path를 일일이 지정해 줘야 하는 불편함이 생기는 측면을 고려.
- `app/batchUnits` 폴더에 배치 유닛 클래스 파일을 정의한다. 또한 `app/batchServices` 폴더에 배치 서비스 클래스 파일을 정의하도록 한다. `app/batches` 폴더 내에 batchUnits와 batchServices 폴더를 정의해도 괜찮다. 그러나 하나의 세트로 묶여야 할 job 부분이 따로 떨어져 있기 때문에 그냥 `app/batchUnits`, `app/batchServices`으로 써도 괜찮아 보인다.
