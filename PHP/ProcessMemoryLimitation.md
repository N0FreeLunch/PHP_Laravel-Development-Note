## PHP의 메모리 관리
- PHP에서 메모리는 프로세스 별로 절대 값을 설정해 줘야 한다.
- PHP에서 기본적으로 한 프로세스당 할당되어 있는 메모리는 128MB이다.

## 프로세스 메모리 설정

### 글로벌 메모리 설정
- 하나의 프로세스가 사용할 수 있는 최대 메모리양을 설정할 수 있다.
- php.ini 파일 설정의 영향을 받는 모든 php 프로세스에 동일하게 최대 메모리를 할당한다.
- php.ini 파일의 memory_limit 옵션에 사용할 메모리 양을 적어 준다.
```
memory_limit = 300M
```

### 파일별 메모리 설정
- `ini_set('memory_limit', 용량);` 명령어를 사용하여  php.ini 파일에 설정된 메모리 사용제한을 초과시킬 수 있다.
- `ini_set('php.ini파일의 설정 키', 'php.ini파일의 설정 값')`으로 구성된다. 
- ini_set 명령의 라이프사이클은 스크립트가 실행되는 지정한 설정 키의 값을 사용하고 스크립트가 끝날때 까지 사용한다.
- ini_set 명령은 php 파일을 파싱하고 프로세스를 시작할 때 프로세스를 세팅해 주는 명령어이다. 따라서 런타임 도중에 변경할 수 없다.
- 런타임 도중에 값을 변경할 수 없기 때문에 필요한 로직에만 특정 값을 지정하고 다시 원래 값으로 복원시키는 것이 불가능하다. 예를 들어 특정 작업을 할 때만 메모리를 크게 할당하고 해당 작업이 끝나고 메모리 사용량을 다시 원래 크기로 제한하는 방식으로 사용할 수 없다.

#### 지정한 크기만큼 메모리 할당하기
```
ini_set('memory_limit','512M');
```

#### 무제한으로 메모리 할당하기
- 메모리 사용량을 가늠하기 어렵고 메모리를 한계까지 사용해서도 반드시 실행해야 하는 작업인 경우 쓴다.
- 문제의 소지가 있기 때문에 추천하지 않는다.
```
ini_set('memory_limit','-1');
```

## CGI의 경우 메모리 세팅

### 프로세스의 수
- 서버에는 쓰레드 x2 만큼 동시 최대 프로세스 수를 지정한다. 최대 프로세스 수가 너무 많으면 컨텍스트 스위칭 비용이 너무 크고, 최대 프로세스 수가 너무 작으면 CPU 코어가 놀게 된다.
- CPU가 유휴대기 상태가 될 때 적당히 컨텍스트 스위칭이 될 수 있도록 CGI 방식의 경우 최대 프로세스를 쓰레드 x2 정도로 지정하는 것을 추천한다.

### 물리적 메모리 초과
- 그런데 하나의 프로세스는 지정된 양의 메모리를 소모한다. '최대 프로세스 수' x '최대 프로세스 메모리양'이 물리적 메모리를 초과할 경우 문제가 발생할 여지가 있다. 다만 이런 경우는 하나의 프로세스가 최대 메모리에 가깝도록 할당될 일이 적기 때문에 잘 일어나지 않는다. 
- 각 프로세스의 메모리가 할당 한계치 까지 갈 일이 적기 때문에 "'최대 프로세스 수' x '최대 프로세스 메모리양' > 물리적 메모리"가 너무 많은 값을 초과하지 않는다면 메모리 문제가 잘 일어나지 않는다.
- 만약 물리적 메모리의 한계를 초과했을 때 문제의 소지를 방지하기 위해 시스템에 스왑 메모리 사이즈를 충분히 두면 된다. 물리적 메모리를 초과하는 경우가 적기 때문에 스왑이 자주 일어나지는 않기 때문에 괜찮다.

## 메모리 제한을 걸 때의 장점
- 기본적으로 설정되어 있는 프로세스별 메모리 128M도 php의 일반적인 메모리 사용량을 고려할 때 큰 수치이다.
- 128M의 메모리를 초과하는 작업이라면 뭔가 문제가 있는 작업일 가능성이 있다.
- 프로세스별로 설정한 메모리 사용량이 초과했다면 해당 부분의 문제가 되는 코드를 개선하거나 메모리 사용량을 최적화 해 줘야 한다.

### 메모리 사용 최적화 방법
- 반드시 구현되어야 하는 기능인데 메모리 제한 때문에 하지 못하는 경우에는 한 단위의 작업을 잘게 나눠서 구현을 하는 방식을 쓰는 편이 좋다.
- chunk 방식 또는 cursor 방식 또는 generator 문법을 사용하여 메모리를 적게 쓰는 방법을 고려하자.
- 화면에 메모리 사이즈 이상의 문자를 출력해야 할 경우 generator 문법 등을 사용하여 조금씩 echo 등의 문법으로 뿌려주는 방법을 사용한다.
- JSON으로 결과 리스트를 리스폰스해야 하는데 리스트의 크기가 너무 커서 한 꺼번에 줄 수 없다면 프론트에서 여러번의 통신으로 데이터를 요청하고 이를 합치는 방식으로 구현하도록 하도록 한다.

### 메모리 제한 초과하기
- `ini_set` 명령어 등으로 프로세스의 메모리 제한을 초과하기 위해서는 트레픽이 최대일 경우에도 물리적 메모리를 초과하지 않는 범위 내에서 사용하는 것이 좋다. 메모리 제한을 초과하는 작업이 자주 있는 일이 아니라면 물리적 메모리를 좀 초과하는 부분은 스왑된 메모리를 사용한다고 생각하고 사용하면 된다.
- php에 프로세스당 메모리 제한을 거는 것은 시스템의 전체 물리적 메모리와 스왑 메모리를 고려하여 결정된다. 이는 트레픽이 많을 경우에도 프로그램 구동에 문제가 생기지 않게 하기 위함이다. 특정 프로세스의 메모리 사용량이 초과 될 수 있다는 것은 초과할 수 있는 경우가 많이 생긴다면 메모리 문제로 서버가 터질 수 있기 때문에 위험하다. 그래서 빈도가 낮은 작업에 대해서 메모리 사용량을 초과하는 것을 고려한다. 
- 물론 트레픽이 많아지면 접속이 지연되거나 커넥션이 이뤄지지 않을 수도 있지만, 메모리 문제가 발생하지 않는다면 대개 프로그램의 구동 자체는 안전하다.
- 하지만 비즈니스 로직이 언제 변경될지 모르고 그에 따라 특정 프로세스 메모리 제한을 초과하는 옵션을 수정때마다 제대로 설정해 주지 않는다면 갑작스런 문제가 생길 여지가 있다. 또한 초과를 허용한 부분의 트레픽이 갑자기 늘 수도 있고 다양한 변수로 메모리 사용량을 초과하는 경우가 생길 수도 있다. 가능한한 메모리 사용량을 초과하는 방식이 아닌 chunk, cursor, generator와 같은 작업 단위를 잘게 나누는 방식을 통해서 메모리 제한을 초과하지 않는 방식으로 로직을 짜는 것이 좋아 보인다.

## CGI가 아닐 때 메모리 세팅
- CGI 방식이 아닐 경우에는 하나의 프로세스가 여러 리퀘스트를 처리하기 때문에 하나의 프로세스의 메모리 크기를 크게 잡아야 한다.
- 보통 하나의 프로세스로 웹 서버를 구동하는 경우 `ini_set('memory_limit','-1');`를 사용하여 메모리 제한을 걸지 않는 방식으로 쓸 수도 있다.

### swoole의 경우
- swoole의 경우에는 이벤트루프 방식으로 구성되어 있다. 모든 리퀘스트에 대한 처리가 되고 있다면 들어 오는 리퀘스트는 소켓 버퍼에 저장이 된다. 따라서 소켓 버퍼를 충분히 늘려 줘야 한다.
- Reference : https://openswoole.com/docs/modules/swoole-server/configuration#socket_buffer_size


## Reference
- https://www.php.net/manual/en/function.ini-set.php
