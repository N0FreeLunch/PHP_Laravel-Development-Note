## HTTP의 특성

- HTTP는 상태를 저장하지 않는 통신을 의미한다.
- HTTP 프로토콜만으로는 이전 리퀘스트와 이후 리퀘스트의 상태는 공유되지 않는다.

## 쿠키의 역할

- 브라우저는 쿠키라는 기능을 지원한다.
- HTTP 통신을 통해 서버에서 리스폰스를 받을 때 헤더에 포함된 set-cookie 부분을 통해서 쿠키값을 받고 브라우저는 리스폰스 헤더에 포함된 쿠키 값을 브라우저에 자동으로 저장한다.
- 자바스크립트 등을 사용해서 쿠키 값에 대한 CURD를 할 수 있지만, 기본적으로 HTTP의 응답 헤더를 통해서 브라우저의 쿠키값이 세팅된다.

## 브라우저

- 브라우저는 쿠키라는 저장소를 가지고 있다. 보통 쿠키값은 브라우저에서 관리하는 임시 폴더에 파일 형태로 저장된다.
- 브라우저는 리퀘스트 통신을 하면서 저장된 쿠키 값을 리퀘스트의 헤더에 달아 서버에 보낸다. (요청헤더 : https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Cookie)
- 브라우저는 리스폰스 통신을 하면서 리스폰스 헤더에 달려 있는 set-cookie 키의 값을 브라우저의 쿠키에 할당한다. (응답헤더 : https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie)

## 유저 식별

- 고유한 유저를 식별하기 위해서 서버는 쿠키값을 활용한다. 쿠키값에는 유저 식별 정보 이외에도 여러가지 정보가 담겨 있다. 브라우저는 리퀘스트 헤더를 서버에 보낼 때 브라우저에 저장된 쿠키 값을 리퀘스트 헤더에 세팅해서 보낸다.
- 서버는 브라우저가 보낸 리퀘스트 헤더에서 유저 정보를 식별하는데 필요한 값을 취득하여 현재 브라우저의 유저가 어떤 유저인지 알 수 있다.

## 새션 저장

서버는 동일 컴퓨터의 동일 브라우저를 식별하기 위해서 어떤 키를 브라우저에 저장을 한다. 브라우저에 저장된 키를 a라고 하자. 서버에서 브라우저에 저장된 키 a와 매칭되는 키를 레디스나 데이터베이스에 저장한 것을 A라고 하자. 일반적으로 서버는 브라우저의 쿠키를 세팅하는 HTTP 리스폰스 헤더에 키 a를 보낸다. 브라우저는 쿠키를 저장하고, 통신이 일어날 때마다 별도의 세팅 없이도 쿠키에 저장된 키 a를 리스폰스 헤더에 담아서 서버로 보낸다. 이 과정을 통해서 서버는 동일 브라우저를 식별할 수 있다.

### 서버 세션에 데이터 저장하기

서버에 저장된 키에 매칭되는 데이터를 서버 측 공유 스토리지(레디스나 디비 등)에 저장하는 것을 통해서 각 세션 정보를 서버 측에서 저장을 할 수 있다. 이를 이용해서 중요한 정보를 클라이언트에 저장하지 않고 서버측에 저장할 수 있다.

## 세션을 활용한 사례 탐구

결제 시스템을 생각해 보자. 유저가 결제 안내 페이지에 도착을 한 후, PG사의 결제 페이지로 안내할 것이다. 결제 도중에 어떤 문제가 발생해서 결제 페이지의 식별 정보가 도착하지 않았다고 하자. 결제 안내 페이지에서 세션을 발급했다면 어떤 결제에 대한 실패인지 알 수 있다. 하지만, 결제할 대상이 여럿이라고 하자. 페이지 H에서 세션을 발급하고, 페이지 I에서 세션을 발급을 할 때, 동일한 브라우저로 두 페이지를 접속하면 페이지가 달라도 동일한 세션이 된다. 동일한 세션에 대해 두 페이지를 식별하기 위해서는 세션 키 A에 매칭하는 H페이지의 데이터 h와 I페이지의 데이터 i 두 가지를 발급 받아야 한다. 그런데 결제 화면에 도착했을 때 안내 페이지의 식별 정보가 없을 때, 세션 A에 담긴 데이터 h와 i가 있을 것이고, 이 둘 중에서 무엇을 선택해야 할지 알 수 없게 된다.

이런 문제점을 해결하기 위한 방법으로는 식별 정보가 없을 때의 도착 화면을 별도로 만들던지, 세션에 담긴 데이터가 복수라면 (여기서는 h와 i) 복수인 경우에 해당하는 안내 페이지를 쓰던지, 하나의 안내 페이지로 PG사 접속이 이뤄진 경우에는 다른 안내 페이지의 PG사로 접속을 하지 못하게 하든지, 브라우저의 세션 스토리지(브라우저의 탭 별로 저장되고, 탭이 닫히면 정보가 사라진다.)에 임시 키를 발급하고 결제 실패 랜딩 페이지에 도착했을 때 브라우저 세션 스토리지에 발급한 키로 도착화면을 확인하는 방법 등을 사용할 수 있다.

### 해커의 공격을 생각해 보기

PG사에서 결제가 완료었을 때, LP 페이지로 이동시킬 때 쿼리 파라메터 등의 정보를 통해서 어떤 결제에 대한 것인지 식별을 할 수 있다. 만약 일부러 LP 페이지 쿼리 파라메터를 조작한다고 하더라도, PG사로 부터 전달되는 별도의 킥벡을 통해서 2중 검증을 한다. 만약 LP 페이지에서 에러가 발생했다면, PG 사에 별도의 요청을 하여 요청이 성공적으로 시도되었는지 확인한다.

## References
- https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie
