## 라이프사이클
- php 엔진을 실행하고 엔진에 리퀘스트를 전달하고 실행할 php 파일을 지정하게 되면, php 엔진이 php 파일을 읽는다.
- php 파일의 코드가 리퀘스트에 관한 정보를 요청하면 php엔진은 실행될 때 전달 받았던 리퀘스트 정보를 php 코드의 실행 부분에 전달한다.
- php 엔진이 파일을 읽고 파일의 읽음이 끝나면 php는 리스폰스를 반환한다. 
- 그리고 php 엔진은 파일을 읽는 것을 끝내고 종료한다.

## 싱글 스레드와 인터프리터
- 컴파일 언어가 아닌 인터프리터 언어는 실시간으로 코드를 해석해야 한다. 순차적인 코드 실행을 해야하기 때문에 싱글 스레드로 해석을 보통 할 수 밖에 없다. 멀티스레드로 코드를 해석한다면 코드를 분리해서 읽어야 하는데, 순차적인 실행으로 앞선 코드의 결과를 뒤의 코드에 집어 넣어서 해석을 하게 된다. 그래서 일반적으론는 분리해서 실행을 할 수 없기 때문에 싱글 스레드로 인터프리터 언어는 해석을 하게 된다.
- 코드를 분할해서 실행을 하기 위해서 인터프리터 언어의 코드를 실행하는 것이 아니라 미리 컴파일 하는 방식을 사용할 수 있다. 그러면 코드 분할이 되어 멀티스레드를 이용할 수 있다. 최종적으로는 싱글 스레드로 컴파일 된 코드를 실행하겠지만 중간에 멀티스레드를 활용하게 되면서 컴퓨터 자원을 유용하게 사용할 수 있다.
- 자바스크립트 엔진 V8 같은 경우에는 미리 컴파일 하는 방식으로 속도를 높이는데 멀티스레드를 사용해서 컴파일 한다는 정보는 없었다. 코드 분할을 해도 구현에 따라 멀티스레드를 이용할 수 없을 수 있다. php도 마찬가지로 자바스크립트 엔진과 같이 미리 컴파일 하는 방식을 어느 정도 도입을 하고 있다. 하지만 php의 경우도 여전히 싱글 스레드로 해석이 되는 것으로 알고 있다.

## 멀티 리퀘스트
- php 코드의 실행은 싱글 스레드로 이뤄진다.
- CGI 방식으로 실행되는 php 엔진은 하나의 리퀘스트에 하나의 프로세스를 할당한다. 여러 리퀘스트가 오면 php 엔진은 여러 프로세스를 실행한다.
- php는 언어 자체의 멀티 스레드 클래스를 지원하지만, 웹 리퀘스트를 처리할 때는 멀티 스레드 기능을 사용하지 말것을 권장하고 있다.
- 만약 스레드가 하나인데 여러 개의 리퀘스트가 도착하게 되면, php는 리퀘스트의 수 만큼 php 프로세스를 생성한다. 물론 생성할 때 그 갯수를 일정량 이상 초과하지 않도록 설정하는 부분이 있다. 이 최대 실행 프로세스의 갯수를 조정하는 것이 자동인지는 조사가 필요하다.
- 여러 개의 php 프로세스가 실행이 되는데 스레드가 하나만 있다면 운영체제의 시분할 프로세스로 각 프로세스를 조금씩 실행을 한다. 그런데 php는 파일을 다 읽어야 리스폰스가 생겨나는 것이므로 중간에 조금 조금씩 동시에 실행하는 것이 그렇게 의미가 있지 않다. 오히려 프로세스에게 자원을 분배하려고 컨텍스트 스위칭이 많이 일어나면 전체적인 동작 속도가 늦어질 수 있다. 그래서 각 프로세스의 리스폰스 속도만 늦어질 뿐이다. 리스폰스가 늦어지지 않게 하기 위해서 php는 스레드 수 만큼 프로세스를 실행 시키도록 한다.
- 웹 서비스는 디비와의 통신 등 외부와의 IO에 시간을 굉장히 할애하고 있고, 이 IO 대기시간을 최대한 활용하기 위해서 스레드 수 이상의 프로세스를 실행을 하여 IO 대기 시간동안 운영체제에 의해 시분할로 처리되는 다른 프로세스가 IO 대기 시간을 활용하도록 만든다. 그래서 스레드의 갯수를 조금 초과하는 방식의 프로세스를 실행 시키도록 한다.


## php의 속도가 느린 이유
### 하나의 리퀘스트에 하나의 프로세스가 실행되기 때문
- php 자체로는 C 언어의 구현체이므로 그렇게 속도가 느린 편은 아니다. 하지만 php 코드가 늘어남에 따라서 다른 언어에 비해 속도가 많이 느려지게 된다. 이 이유는 다른 언어 같은 경우에는 미리 웹 프레임워크의 코드를 메모리에 올려두고 리퀘스트에 해당하는 부분만 메모리를 생성하고 처리한다. 하지만 php는 리퀘스트 요청 하나가 오면 프레임워크의 코드를 읽고 메모리에 올리게 된다. CGI 방식의 경우 하나의 리퀘스트에 대해 프레임워크에 기본적으로 필요한 코드 + 리퀘스트 처리에 관한 코드 이렇게 두 부분을 올려서 처리를 해야하기 때문에 많은 기능이 탑제된 php 웹 프레임워크는 엄청 느린 속도를 보여준다.

### 지속성 연결을 사용하지 않기 때문
- php는 php 코드에 커넥션에 관한 정보를 저장한다. php 코드가 실행이 되고 나서야 디비 접속이 이뤄지는 것이다. 그래서 php 프로세스가 실행이 되고 나서 연결이되고 php 프로세스가 종료가 되면 디비 접속이 끊긴다. 계속적으로 커넥션을 유지하지 못하는 단점이 있다.
- 그러면 엔진쪽이나 php-fpm 쪽에서 디비에 대한 커넥션풀을 만들어 주면 되지 않을까 생각을 해 볼 수 있는데 php가 종료 되어도 디비 접속을 끊는다는 통신을 하지 않도록 PHP-FPM에서 설정을 해 주면 가능하다. 이런 커넥션을 유지하는 방법을 퍼시스트 커넥션이라고 한다. 데이터베이스는 동일한 요청원에 대해 커넥션을 끊는 통신이 도달하지 않았다면 기존 커넥션 정보를 재사용하는 기능이 있으며 재사용기능을 통해 연결 오버헤드를 줄여 속도적인 문제를 조금 더 해결할 수 있다.

## 느린 php를 보강하기 위한 방법
- CGI 방식으로 리퀘스트 실행시 공통으로 실행되는 코드가 메모리에 올라가 있지 않기 때문에 필요한 모든 PHP 파일을 읽는 속도 문제가 발생할 수 밖에 없다. 이러한 속도 문제를 최대한 완화하기 위해 php는 opcache라는 컴파일 코드 단계에서의 코드 캐싱 기능을 제공한다. 하지만 근본적인 문제인 코드를 메모리에 다시 올려야 하는 문제는 해결되지 않기 때문에 느릴 수 밖에 없다.

