## 데이터베이스의 특징
- 데이터베이스는 하나의 스레드에 하나의 연결만을 가진다. 하나의 연결은 트렌젝션을 수행할 수 있는 단위이고 이는 싱글 스레드에서 처리되도록 만들어져 있다. 왜냐하면 일반적으로 웹 애플리케이션에서 사용하는 데이터베이스는 트렌젝션이 가능한 데이터베이스여야 하고 트렌젝션이 가능하기 위해서는 순차처리 로직으로 짜는 편이 그나마 낫기 때문에 싱글 스레드를 활용한 방식으로 구현된다.
- 데이터베이스의 작업은 CPU 집약적인 작업이고 I/O 처리는 CPU 작업의 인텐스에 비하면 낮은 비중을 가지고 있다. IO 처리에서의 병목 보다 CPU 집약적인 처리에서 병목이 주로 발생한다. 따라서 하나의 스레드를 동시 작업에 할당하는 시분할 처리 방식을 사용하기 보다는 cpu 성능을 스위칭 작업에 할당하지 않고 데이터베이스의 로직 처리에 최대로 활용할 수 있는 싱글 스레드 전체를 풀로 사용하는 방식을 사용한다.
- 그래서 데이터베이스로 비동기 처리를 하기 위해서는 연결을 여러 개 만들어 줘야 한다. 각 연결이 하나의 스레드를 사용하게 되고 각각은 독립적으로 쿼리 로직을 처리한다.


## 데이터베이스에서의 병렬 쿼리
- 데이터베이스의 커넥션이 하나만 매어져 있을 때, 쿼리는 순차적으로 이뤄진다. 하나의 커넥션에서 다음 쿼리가 실행되기 위해서는 이전 쿼리의 처리가 끝나야 한다.
- 여러 쿼리를 동시에 처리하기 위해서는 커넥션이 여러 개 맺어져야 한다.


## PHP의 특징
- PHP는 기본적으로 하나의 리퀘스트 라이프사이클에 하나의 프로세스가 실행되는 구조이다.
- 물론 하나의 프로세스 위에 다양한 리퀘스트를 처리할 수 있는 서버를 만드는 방식도 있지만 보편적으로 사용되는 방식은 아니다.


## 병렬 쿼리의 장점과 단점
- 쿼리를 순차적으로 두 번 실행하는 것에 비해, 병렬로 두 개를 동시에 처리하는 시간이 더 많이 걸릴 수 있다.
- 복잡한 소수의 쿼리를 날리는 것 보다 단순한 여러 개의 쿼리를 날릴 때 처리하는 시간이 더 짧게 걸리는 경우가 있기 때문에 이런 경우 사용하면 처리 시간을 단축을 할 수 있다.


## 복수 프로세스로 다중쿼리
- PHP는 기본적으로 하나의 프로세스에 하나의 연결을 가진다. 물론 하나의 프로세스가 여러 연결을 가지도록 설정을 할 수도 있지만 보편적인 사용 방법은 하나의 프로세스가 하나의 데이터베이스 커넥션을 가지는 방법이다.
- 하나의 프로세스가 하나의 디비 커넥션을 가지고, 하나의 디비 커넥션은 동시에 하나의 쿼리만 처리할 수 있기 때문에 여러 PHP 프로세스를 켜야 동시에 여러 커넥션을 만들고 여러 쿼리를 처리할 수 있다.
- 여러 PHP 프로세스를 켜기 위해서 쿼리 처리를 위한 API를 만드는 방식을 주로 활용한다.


## 하나의 프로세스에서의 다중쿼리
- mysqli 드라이버 또는 PDO 드라이버의 특정 옵션을 지정해 주는 것으로 병렬 쿼리를 날릴 수 있다.
- php의 기본 memory_limit는 128M이다. 병렬 쿼리를 날렸을 때, 받는 결과는 병렬 쿼리 결과들의 합이 되기 때문에 대량의 결과를 받는 쿼리라면 메모리 문제가 발생할 수 있으므로 메모리 값을 바꿔 줘야 한다. (https://www.php.net/manual/en/ini.core.php#ini.memory-limit)


#### 설정
- PDO의 경우 : https://www.php.net/manual/en/ref.pdo-mysql.php#pdo-mysql.constants
- mysqli의 경우 : https://www.php.net/manual/en/mysqli.poll.php
- pgsql의 경우 : https://www.php.net/manual/en/function.pg-send-query.php


## PHP의 단점
- PHP는 쿼리 I/O에 대해 기본적으로 블로킹처리를 한다. PHP에서 코딩을 할 때, 쿼리 I/O를 대기하는 동안 로직이 멈추기 때문에 CPU에 유휴 시간이 생긴다.
- CPU에 스래드가 존재하면 동일 코어를 공유하는 스래드에 대해 하나의 스래드가 블락이 되어 있을 때, 다른 스래드로 작업이 이뤄진다.


## 활용 방안
- API 통신을 통한 병렬 쿼리 생성


## Referencce
- https://stackoverflow.com/questions/27240421/php-asynchronous-mysql-query
