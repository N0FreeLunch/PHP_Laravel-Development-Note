# 블록 스코프

## 스코프란?

스코프란 변수의 유효 범위를 뜻한다. 보통은 블록 또는 함수 블록이 열렸을 때, 블록 내부에서 선언된 변수는 블록이 닫히면 소멸한다. 블록 안에서 선언된 변수는 블록 밖에서 사용할 수 없다.

### 자바스크립트로 이해하기

자바스크립트는 var로 선언된 변수는 함수 스코프를 가지고 있고, const나 let으로 선언된 변수는 블록 스코프를 가지고 있다. php를 위한 설명이므로 변수에 $를 붙여 주었다.

#### 블록 스코프

```js
if (true) {
    let $a = 10;
}

console.log($a); // Uncaught ReferenceError: $a is not defined
```

블록 내에서 선언된 $a는 블록 밖에서 접근할 수 없다.

```js
fn = function () {
    let $a = 10;
}

console.log($a); // Uncaught ReferenceError: $a is not defined
```

함수 내에서 선언된 $a는 블록 밖에서 접근할 수 없다.

#### 함수 스코프

```js
if (true) {
    var $a = 10;
} else {
    var $b = 20;
}

console.log($a); // 10
console.log($b); // undefined
```

자바스크립트의 전역 변수는 전역 스코프를 함수 스코프로 한다. 함수 내부에 있지 않지만 함수 스코프의 변수는 전역 스코프를 함수 스코프로 사용한다고 보면된다.

자바스크립트에서는 php의 isset과 같은 정의된 변수인지 아닌지 확인하는 기능이 존재하지 않는다. 그래서 변수를 선언하는 코드가 실행되지 않더라도 변수를 사용하는데 에러가 발생하지 않도록 해야 한다. 자바스크립트는 에러를 발생시키지 않는 대신 undefined 값으로 표기하는 방식을 사용한다.

함수 스코프를 가진 변수 $b는 실행이 되지 않았음에도 불구하고 에러가 아니라 undefined 값이된다.

```js
const fn = function () {
    var $a = 10;
}

console.log($a); // Uncaught ReferenceError: $a is not defined
```

함수 스코프 안에서 선언된 변수는 함수 밖에서 접근할 수 없다.

함수 스코프를 가지는 변수가 블록 안에서 선언되었을 때는 undefined 값으로 접근할 수 있었던 것에 반해서, 함수 스코프 밖에서는 undefined 값으로 접근하는 것이 아닌 에러를 발생시킨다.

## 인터프리터 언어

C 계열의 문법적 특징을 가진 언어는 블록 스코프를 가진다. 하지만 ES6 이전의 자바스크립트, PHP, 파이썬 등의 인터프리터 언어는 함수 스코프를 가진다.

## 블록 스코프의 장점

블록을 사용하면, 변수는 블록 안에서 선언되고, 선언된 블록 밖에서는 접근할 수 없게 된다. 이는 변수가 소멸된다기 보다는 접근을 못하게 되는 것으로 블록 안에서 선언하고 블록의 닫힘과 함께 쓰임을 다하는 블록 안에서만 쓰이는 임시적인 변수를 부담없이 만들 수 있다는 장점이 있다. 변수를 많이 만들더라도 로직의 흐름을 기술하는 부분의 변수의 갯수를 억제하고, 흐름에서 단위가 되는 부분에서 임시로 사용할 변수를 부담없이 자유롭게 생성할 수 있다.

### 블록 스코프가 없을 때의 문제

블록 스코프가 없고 함수 스코프만 사용할 수 있는 언어에서, 블록은 흐름을 if, for, switch 등의 문법들과 함께 이들 문법의 작용 범위를 정하는 용도로 사용된다. 블록 스코프가 없기 때문에 함수 내에 선언되는 모든 변수는 블록 안에 있더라도 함수 스코프 안에 존재하게 된다. 블록 스코프라면, 블록의 내부에 임시 변수를 사용해서 쓸 수 있겠지만, 블록 스코프가 없는 경우는 임시적으로 사용할 변수를 선언할 때, 블록의 종료와 함께 사라지는 것이 아니고 블록들을 감싸고 있는 함수 스코프에 그대로 남게 된다는 문제점이 발생한다.

특정 맥락에서 일시적으로 사용하는 변수가 함수 스코프 전체에 남게 되면서, 함수 내부의 로직이 길어지면 길어질수록 전체 로직에서 사용되는 변수 보다는 일시적으로 사용되는 변수가 많아지는 문제가 발생한다. 무엇이 쓰는 변수이고 무엇이 쓰이지 않는 변수인지 변수의 수를 적게 유지하는 것이 좋음에도 불구하고 변수의 양이 많아지면서, 써야될 변수와 쓰지 말아야 할 변수를 구분하기 힘들어진다.

## 블록 스코프의 필요성

블록 스코프가 없을 때 로직이 길어질 수록 임시적으로 쓰이는 변수가 늘어나게 되므로, 블록 스코프를 도입하자는 의견에 대해, 애초에 하나의 함수 스코프를 길게 잡는 것이 올바른 코딩 프렉티스가 아니라는 의견으로 맞선다. 하지만 때때로 하나의 스코프 내에 장황하게 쓸 수 밖에 없는 로직이 있고, 로직을 분리하는 것이 어색한 경우가 있을 수 있으므로 블록 스코프를 도입하는 것이 좋다는 의견이 있다.

## 필요하다면 함수 스코프를 사용하자.

기본적으로 하나의 함수 스코프의 로직을 장황하게 작성하지 않는 것을 먼저하고, 함수로 로직을 나누는 것이 어려운 경우, 함수 스코프를 사용하여 로직을 분리해서 작성할 것을 권한다. 

함수를 사용하는 것은 해당 스코프가 갖는 역할이 무엇인지 나타내고 개념적인 분리를 통해서 블록 내부의 코드를 읽지 않고서도 코드의 흐름이나 맥락을 함수의 시그니처를 통해서 알 수 있게 해 준다는 장점이 있다. 블록은 함수의 시그니처를 쓰지 않아도 되어 편리한 반면, 특별한 명칭이 없기 때문에 블록의 역할을 사용된 문법과 맥락에 따라 생각해 내야 하는데, 블록 스코프가 없고 함수 스코프만 있는 언어는 함수를 사용하면 이름을 붙여주기 때문에 임시 변수를 사용하는 경우 적절한 함수 추상화를 권장하는 압력을 받는다.

함수로의 추상화는 함수의 시그니처로 함수의 역할을 대략적으로 알 수 있도록 하며, 임시 변수를 가져야 하는 블록에 이름을 부여하여 코드의 사용 의도를 명확하게 할 수 있다는 장점이 있지만, 기본적인 함수의 시그니처도 제대로 만들지 못하는 사람들이 있으며 블록 스코프가 없이 함수를 잘 만들면 된다는 기대는 언어 사용자에 대한 지나친 낙관이며 허황된 기대라고 본다.

### 함수 스코프와 블록 스코프의 장단점

때때로 함수로 분리하는 것은 코드를 늘려 장황한 느낌을 줄 수 있어 함수 사용을 피하고 싶고, 굳이 재사용할 필요가 없는데도 함수로 만들게 되면 마치 재사용해야 할 것과 같은 인상을 줄 수 있어 함수 사용을 피하고 싶고, 흐름상 변수만 격리하는 패턴의 코드를 만들고 싶은 경우가 있다. 이 때는 즉시 실행 함수를 사용하여 코드를 만들 수 있다.

문제는 함수 스코프에 외부의 변수를 전달하기 위해서 use 키워드로 함수 밖에서 함수 내부에 사용할 변수를 전달해 주어야 하며, 많은 변수를 전달해야 하는 경우 익명함수의 중첩이 깊어질수록 변수를 전달해야 하는 것으로 인해서 깊은 중첩을 할 수 없다는 점이다. 깊은 중첩을 장려하지 않게 하므로 좋은점이지만, 일부 케이스에 대해서는 차라리 깊은 중첩이 나은 경우가 있을 수도 있다. 하지만 극소수의 케이스를 위해서 깊은 중첩이란 안티 패턴을 장려할 필요는 없을 것이다. use 키워드로 외부 스코프의 변수를 캡쳐하는 것은 괜찮은 문법이라 할 수 있다.

블록 스코프가 없기 때문에 임시적으로 사용할 변수의 공간을 만들기 위해 즉시 실행 함수의 사용을 남발하는 코드를 만들 수 있는데, 다른 언어의 코드 베이스에서 보기 어려운 코드 스멜이 나는 코드가 될 수 있다는 점이다. 이걸 블록 스코프가 없고 함수 스코프만 있는 언어가 가지는 적합한 코딩 스타일인지, 코드 스멜인지 논란의 소지가 있다.

### 임시 변수

코드의 전개 과정에서 짧은 단위의 코드에서만 사용되고 더 이상 사용되지 않는 변수를 만들 때는 `unset`을 활용하여 함수 스코프의 변수가 오염되지 않도록 코드를 만드는 것이 좋을 수 있다.

## 변수 섀도잉 (Variable Shadowing)

블록 스코프는 스코프 밖의 변수를 스코프 안에서 동일한 이름의 변수명을 선언해서, 상위 스코프의 변수를 하위 스코프에서 덮어 씌우는 것을 의미한다.

스코프의 중첩이 깊어지면, 특정 변수가 상위 스코프의 어디에서 가져온 것인지 하위 스코프의 어디에서 섀도잉이 되었는지 파악해야 하는 문제가 생긴다. 변수명이 같기 때문에 어디서 선언된 변수인지 알아야 변수를 사용할 때 잘못된 사용을 방지할 수 있다. 자바스크립트에서 변수 선언 키워드로 const가 존재하는 것은 하위 스코프의 변수가 덮어 써 지는 것을 방지하기 위함이다.

## References

- https://externals.io/message/109029
