## PHP 엔진
- PHP 코드 문서를 PHP 엔진으로 실행을 시키면 하나의 PHP 프로세스가 생성되고 해당 문서와 연결된 모든 PHP 코드들은 생성된 프로세스에 의해 실행된다.


## I/O 코드
- I/O 작업이 일어나면 PHP의 코드는 블락이 된다. I/O 작업이 끝나야 코드가 실행이 되면서 CPU를 사용하게 된다.
- I/O로 인해 코드 실행에 블락이 일어날 때, PHP는 효과적으로 CPU를 쓸까?


## Context switching
- 컨텍스트 스위칭은 문맥 교환이라는 용어로 CPU 계층에서, OS 계층에서, 프로그래밍 언어 계층에서 사용된다.


### CPU 계층에서의 컨텍스트 스위칭
- CPU의 컨텍스트 스위칭은 하나의 CPU가 A라는 프로세스의 연산을 처리하다가 B라는 프로세스의 연산을 처리하는 것을 의미한다.


### OS 계층에서의 컨텍스트 스위칭
- OS 계층에서의 컨텍스트 스위칭은 A라는 프로세스가 OS의 시스템 API를 콜 하여 I/O 작업을 하게 되면 CPU의 블락처리를 감지하고 A라는 프로세스가 처리되고 유휴상태가 된 스레드에 B라는 프로세스를 할당하는 작업을 의미한다.
- CPU 갯수 보다 프로세스의 갯수가 많은 경우 서로 OS는 각 프로세스에 CPU 자원을 어떻게 할당할지를 결정하는 알고리즘을 실행하고 이 알고리즘은 일반적은 OS에서 가능한 자원을 고르게 할당하려고 한다. OS의 자원할당을 결정하는 방법은 복잡하기 때문에 여기서는 스킵한다.


### 프로그래밍 언어에서의 컨텍스트 스위칭
- 하나의 루틴을 컨텍스트 스위칭한다. A라는 루틴이 I/O 작업을 하여 블락이 되면, B라는 루틴을 A루틴을 할당한 CPU에 할당한다. (설명을 나중에 좀 더 추가)
- OS 계층의 컨텍스트 스위칭 보다 리소스를 소모하는 비용이 적어서 효율이 좋다고 표현한다.


## PHP에서의 컨텍스트 스위칭
- PHP도 swoole이나 php amp, reactPHP, Fiber 등은 컨텍스트 스위칭을 한다. 이는 프로그래밍 언어에서의 컨텍스트 스위칭에 해당한다. php amp, reactPHP, Fiber의 경우 프로세스가 실행되고 있는 싱글 스레드 내에서의 컨텍스트 스위칭이고 병렬성을 고려한 컨텍스트 스위칭은 아니다.
- swoole, php amp, reactPHP, Fiber 이외의 CGI 방식의 보편적인 PHP의 사용에서 프로그래밍 언어 계층의 컨텍스트 스위칭을 하기 보다는 PHP 프로세스 각각에 대해서 컨텍스트 스위칭을 사용한다.
- FastCGI의 전달으로 ZEND 엔진의 PHP가 실행이 되고, 이때 젠드 엔진은 리퀘스트 하나에 대해서 하나의 프로세스를 생성한다. 복수의 리퀘스트에 의해서 복수의 PHP 프로세스가 실행이 된 상황일 경우에 OS의 컨텍스트 스위칭에 의해 하나의 PHP 프로세스가 블락된 상황이면 다른 PHP 프로세스를 블락된 프로세스가 할당된 CPU 스레드에 할당한다.


## PHP-FPM에서 프로세스 갯수 설정
- 만약 복수의 PHP 프로세스가 실행되어 있는데, 프로세스의 양보다 CPU 스레드의 갯수가 적을 경우 프로세스 각각에 가능한한 공평하게 실행을 할당하려고 하기 때문에 컨텍스트 스위칭이 일어나게 된다.
- PHP-FPM에서 CPU 양에 비해 너무 많은 PHP 프로세스를 생성하도록 허가하면 컨텍스트 스위칭이 자주 일어나고, 컨텍스트 스위칭 또한 스위칭에 컴퓨팅 자원을 사용하기 때문에 전체적인 처리 속도가 늦어지는 경우가 생긴다. 또한 각 프로세스가 CPU 자원을 분할하기 때문에 전체실행 속도가 늦어질 수 있다.
- CPU 양에 비해 너무 적은 PHP 프로세스를 생성하도록 허가하면 A라는 PHP 프로세스가 블락되었을 경우 나머지 PHP 프로세스들도 각자 따로 스레드에 할당이 되었기 때문에 남는 PHP 프로세스가 없어서 A가 할당되어 있던 CPU는 유휴 상태가 된다.
- CPU의 스래드 갯수에 비해 PHP 프로세스가 너무 많아도 효율이 떨어지고, 너무 적어도 효율이 좋지 않다는 원리를 알 수 있다. 어느정도 할당을 할지는 어떤 기능을 사용하는지 어떤 코드에 부하가 몰리는지에 따라 다르기 때문에 일반화 할 수 없다. 모니터링을 하면서 적절한 수치를 찾아야 한다. 일반적으로 CPU 스레드 대비 최대 프로세스의 갯수는 1.2배~2.0 정도 할당한다.

## swoole
- php에서 동시성을 다루기 위한 방법으로 php amp, reactPHP, Fiber등이 있지만 swoole은 병렬성을 고려한 프로그래밍을 가능하게 한다. swoole의 코루틴은 고루틴을 모방하여 만들어졌다.
- 하지만 swoole에서 병렬 프로그래밍을 하기 위해서는 기존의 CGI 방식과는 호환이 맞지 않는 문제점이 있어서 swoole 자체로 웹 서버를 열어야 하는 등의 설정 방법이 필요하다.
- 언어 자체에서 병렬성을 코루틴 방식으로 지원하기 때문에 컨텍스트 스위칭 비용을 굉장히 절약할 수 있다는 것이 장점이다.
